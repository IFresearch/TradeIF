<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self' blob:; child-src 'self' blob:; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' data: https://cdnjs.cloudflare.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://cdnjs.cloudflare.com;">
    <title>TradeIF - é‡åŒ–å›æµ‹å¹³å°</title>
    <!-- TradingView Lightweight Charts - ä¸“ä¸šKçº¿å›¾è¡¨åº“ -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Monaco Editor - VS Codeç¼–è¾‘å™¨ -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    <style>
        :root {
            --primary-color: #2962FF;
            --primary-dark: #1E53E5;
            --success-color: #26A69A;
            --danger-color: #EF5350;
            --warning-color: #FF9800;
            --bg-primary: #131722;
            --bg-secondary: #1E222D;
            --bg-tertiary: #2A2E39;
            --text-primary: #D1D4DC;
            --text-secondary: #787B86;
            --border-color: #2A2E39;
            --hover-bg: #2A2E39;
            --chart-bg: #131722;
            --grid-color: #2A2E39;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            max-width: 100%;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .header-stat span {
            color: var(--text-primary);
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            display: flex;
            height: calc(100vh - 60px);
            gap: 0;
            overflow: hidden;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            height: 100%;
            min-width: 280px;
            max-width: 50vw;
            width: 350px;
            flex-shrink: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* è°ƒæ•´å™¨ */
        .resizer {
            width: 4px;
            cursor: col-resize;
            background: var(--border-color);
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        
        .resizer:hover {
            background: var(--primary-color);
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            background: var(--bg-primary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* è¡¨å•ç»„ä»¶ */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }
        
        .form-group input::placeholder {
            color: var(--text-secondary);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            width: 100%;
            padding: 0.875rem 1.25rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(41, 98, 255, 0.3);
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            box-shadow: none;
        }
        
        .btn-secondary:hover {
            background: var(--hover-bg);
            box-shadow: none;
        }
        
        .btn-success {
            background: var(--success-color);
            box-shadow: 0 2px 8px rgba(38, 166, 154, 0.3);
        }
        
        .btn-success:hover {
            background: #229A8E;
            box-shadow: 0 4px 12px rgba(38, 166, 154, 0.4);
        }
        
        .btn-danger {
            background: var(--danger-color);
            box-shadow: 0 2px 8px rgba(239, 83, 80, 0.3);
        }
        
        .btn-danger:hover {
            background: #E53935;
            box-shadow: 0 4px 12px rgba(239, 83, 80, 0.4);
        }
        
        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-btn {
            padding: 1rem 1.75rem;
            background: none;
            border: none;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--bg-primary);
        }
        
        .tab-content {
            padding: 1.5rem;
            padding-bottom: 3rem;
            height: calc(100vh - 120px);
            display: none;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .tab-content::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        .tab-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        /* å›¾è¡¨å®¹å™¨ - TradingViewé£æ ¼ */
        .chart-container {
            width: 100%;
            height: calc(100vh - 280px);
            min-height: 450px;
            max-height: 750px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
            overflow: visible;
            background: var(--chart-bg);
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            margin-bottom: 2rem;
            padding-bottom: 10px;
        }

        .chart-tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(19, 23, 34, 0.96);
            border: 1px solid rgba(42, 46, 57, 0.8);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 0.8125rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 1px rgba(255,255,255,0.1);
            z-index: 1000;
            min-width: 220px;
            max-width: 320px;
            line-height: 1.5;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .chart-tooltip .tooltip-date {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-size: 0.875rem;
            border-bottom: 1px solid rgba(42, 98, 255, 0.2);
            padding-bottom: 0.375rem;
        }

        .chart-tooltip .tooltip-values {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.375rem 1rem;
            margin-bottom: 0.25rem;
        }

        .chart-tooltip .tooltip-values span {
            color: var(--text-secondary);
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .chart-tooltip .tooltip-values span[colspan="2"] {
            grid-column: 1 / -1;
        }

        .chart-tooltip .tooltip-values strong {
            color: var(--text-primary);
            margin-left: 0.25rem;
            font-weight: 600;
        }
        
        .chart-tooltip .tooltip-trade {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(197, 203, 206, 0.15);
        }
        
        .chart-tooltip .tooltip-trade div {
            line-height: 1.6;
        }
        
        /* å›¾è¡¨å·¥å…·æ æ ·å¼ */
        .chart-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: rgba(19, 23, 34, 0.95);
            border-bottom: 1px solid var(--border-color);
            height: 40px;
            user-select: none;
        }
        
        .chart-toolbar-left,
        .chart-toolbar-right {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .chart-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.375rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .chart-btn-active {
            background: var(--primary-color);
            color: white;
        }
        
        .chart-btn-active:hover {
            background: var(--primary-dark);
        }
        
        .chart-divider {
            width: 1px;
            height: 20px;
            background: var(--border-color);
            margin: 0 0.5rem;
        }
        
        .chart-wrapper {
            position: relative;
        }

        #tradingview-chart, #equity-chart {
            width: 100%;
            height: 100%;
            position: relative;
        }        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .stat-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .stat-card h3 {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
        }
        
        .stat-card.positive .value {
            color: var(--success-color);
        }
        
        .stat-card.negative .value {
            color: var(--danger-color);
        }
        
        /* æ¶ˆæ¯æç¤º */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        
        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(239, 83, 80, 0.1);
            color: var(--danger-color);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 3px solid var(--danger-color);
            font-size: 0.875rem;
        }
        
        .success {
            background: rgba(38, 166, 154, 0.1);
            color: var(--success-color);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 3px solid var(--success-color);
            font-size: 0.875rem;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            text-align: left;
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        tr:hover {
            background: var(--hover-bg);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Monacoç¼–è¾‘å™¨å®¹å™¨ */
        #editor-container {
            height: 600px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* ç­–ç•¥æ¨¡æ¿é€‰æ‹©å™¨ */
        .template-selector {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .template-selector label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .template-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }
        
        .template-btn {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .template-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .template-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        /* æ•°æ®ç®¡ç†æ ·å¼ */
        .cache-management-container {
            padding: 0;
        }
        
        .cache-actions {
            margin-bottom: 2rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .cache-actions .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .cache-status h4 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .status-value {
            color: var(--primary-color);
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .status-good {
            color: var(--success-color);
        }
        
        .status-warning {
            color: var(--warning-color);
        }
        
        .status-error {
            color: var(--danger-color);
        }
        
        /* ç­–ç•¥å‚æ•°åˆ‡æ¢æ ·å¼ */
        .strategy-params {
            transition: all 0.3s ease;
        }
        
        .strategy-params.hidden {
            display: none !important;
        }
        
        /* äº¤æ˜“åˆ—è¡¨æ ·å¼ */
        .trade-positive {
            color: var(--success-color) !important;
        }
        
        .trade-negative {
            color: var(--danger-color) !important;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 968px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                max-width: 100%;
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .resizer {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">IF</div>
                <span>TradeIF</span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <span id="header-status">â— ç³»ç»Ÿå°±ç»ª</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="form-group">
                <label for="stockCode">è‚¡ç¥¨ä»£ç </label>
                <input type="text" id="stockCode" name="stockCode" value="000001.SZ" placeholder="è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ">
                <small>æ ¼å¼:000001.SZ æˆ– 600000.SH</small>
            </div>
            
            <div class="form-group">
                <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="startDate" name="startDate">
            </div>
            
            <div class="form-group">
                <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                <input type="date" id="endDate" name="endDate">
            </div>
            
            <div class="form-group">
                <label for="strategy">äº¤æ˜“ç­–ç•¥</label>
                <select id="strategy" name="strategy" onchange="onStrategyChange()">
                    <option value="ma_cross">åŒå‡çº¿äº¤å‰ç­–ç•¥</option>
                    <option value="rsi">RSIè¶…ä¹°è¶…å–ç­–ç•¥</option>
                    <option value="bollinger">å¸ƒæ—å¸¦ç­–ç•¥</option>
                    <option value="custom">è‡ªå®šä¹‰ç­–ç•¥</option>
                </select>
            </div>
            
            <!-- ç­–ç•¥å‚æ•°é…ç½® -->
            <div id="strategyParams">
                <!-- åŒå‡çº¿ç­–ç•¥å‚æ•° -->
                <div id="ma_cross_params" class="strategy-params">
                    <div class="form-group">
                        <label for="shortWindow">çŸ­æœŸå‡çº¿</label>
                        <input type="number" id="shortWindow" name="shortWindow" value="20" min="2" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="longWindow">é•¿æœŸå‡çº¿</label>
                        <input type="number" id="longWindow" name="longWindow" value="50" min="2" max="200">
                    </div>
                </div>
                
                <!-- RSIç­–ç•¥å‚æ•° -->
                <div id="rsi_params" class="strategy-params" style="display: none;">
                    <div class="form-group">
                        <label for="rsiPeriod">RSIå‘¨æœŸ</label>
                        <input type="number" id="rsiPeriod" name="rsiPeriod" value="14" min="2" max="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="oversoldThreshold">è¶…å–é˜ˆå€¼</label>
                        <input type="number" id="oversoldThreshold" name="oversoldThreshold" value="30" min="10" max="40" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="overboughtThreshold">è¶…ä¹°é˜ˆå€¼</label>
                        <input type="number" id="overboughtThreshold" name="overboughtThreshold" value="70" min="60" max="90" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="rsiStopLoss">æ­¢æŸæ¯”ä¾‹</label>
                        <input type="number" id="rsiStopLoss" name="rsiStopLoss" value="0.05" min="0.01" max="0.20" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="rsiTakeProfit">æ­¢ç›ˆæ¯”ä¾‹</label>
                        <input type="number" id="rsiTakeProfit" name="rsiTakeProfit" value="0.10" min="0.02" max="0.50" step="0.01">
                    </div>
                </div>
                
                <!-- å¸ƒæ—å¸¦ç­–ç•¥å‚æ•° -->
                <div id="bollinger_params" class="strategy-params" style="display: none;">
                    <div class="form-group">
                        <label for="bollingerPeriod">å¸ƒæ—å¸¦å‘¨æœŸ</label>
                        <input type="number" id="bollingerPeriod" name="bollingerPeriod" value="20" min="5" max="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="stdMultiplier">æ ‡å‡†å·®å€æ•°</label>
                        <input type="number" id="stdMultiplier" name="stdMultiplier" value="2.0" min="1.0" max="3.0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="bollingerStopLoss">æ­¢æŸæ¯”ä¾‹</label>
                        <input type="number" id="bollingerStopLoss" name="bollingerStopLoss" value="0.05" min="0.01" max="0.20" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="bollingerTakeProfit">æ­¢ç›ˆæ¯”ä¾‹</label>
                        <input type="number" id="bollingerTakeProfit" name="bollingerTakeProfit" value="0.10" min="0.02" max="0.50" step="0.01">
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰ç­–ç•¥å‚æ•° -->
                <div id="custom_params" class="strategy-params" style="display: none;">
                    <div class="form-group">
                        <label for="customCodeEditor">è‡ªå®šä¹‰äº¤æ˜“é€»è¾‘ä»£ç </label>
                        <div id="customCodeEditor" style="width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;"></div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 0.75rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>æ”¯æŒè¯­æ³•é«˜äº®ã€ä»£ç æŠ˜å ã€è‡ªåŠ¨è¡¥å…¨ç­‰ä¸“ä¸šåŠŸèƒ½ã€‚<br>
                            <strong>å¯ç”¨å˜é‡ï¼š</strong><code style="color: var(--primary-color);">current</code>, <code style="color: var(--primary-color);">prev</code>, <code style="color: var(--primary-color);">position</code>, <code style="color: var(--primary-color);">entry_price</code>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>é¢„è®¾ç­–ç•¥æ¨¡æ¿</label>
                        <select id="templateSelect" name="templateSelect" onchange="loadTemplate()">
                            <option value="">é€‰æ‹©æ¨¡æ¿...</option>
                            <option value="ma_cross">åŒå‡çº¿äº¤å‰ (ä¿®æ­£ç‰ˆ)</option>
                            <option value="rsi_divergence">RSIè¶…ä¹°è¶…å– (ä¿®æ­£ç‰ˆ)</option>
                            <option value="bollinger_bounce">å¸ƒæ—å¸¦åå¼¹ (ä¿®æ­£ç‰ˆ)</option>
                            <option value="volume_breakout">æˆäº¤é‡çªç ´ (ä¿®æ­£ç‰ˆ)</option>
                            <option value="multi_factor">å¤šå› å­ç»¼åˆç­–ç•¥ (æ–°)</option>
                            <option value="custom_indicators">è‡ªå®šä¹‰æŒ‡æ ‡ç­–ç•¥ (æ–°)</option>
                            <option value="mean_reversion">å‡å€¼å›å½’ç­–ç•¥ (æ–°)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 0.75rem;">
                        <button type="button" class="btn btn-success" onclick="validateCode()">
                            <span>âœ“</span> éªŒè¯ä»£ç 
                        </button>
                        <button type="button" class="btn btn-danger" onclick="clearCode()">
                            <span>âœ—</span> æ¸…ç©ºä»£ç 
                        </button>
                    </div>
                    
                    <div id="codeValidation" style="margin-top: 10px; padding: 12px; border-radius: 6px; display: none; font-size: 0.875rem;"></div>
                </div>
            </div>
            
            
            <div class="form-group">
                <label for="initialCapital">åˆå§‹èµ„é‡‘</label>
                <input type="number" id="initialCapital" name="initialCapital" value="100000" min="10000" step="10000">
            </div>
            
            <button class="btn" onclick="loadData()">åŠ è½½æ•°æ®</button>
            <button class="btn btn-secondary" onclick="runBacktest()">è¿è¡Œå›æµ‹</button>
        </div>
        
        <!-- å¯æ‹–æ‹½è°ƒæ•´å¤§å°çš„åˆ†éš”æ¡ -->
        <div class="resizer" id="resizer"></div>
        
        <!-- ä¸»å†…å®¹ -->
        <div class="main-content">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chart', this)">ä»·æ ¼å›¾è¡¨</button>
                <button class="tab-btn" onclick="switchTab('backtest', this)">å›æµ‹ç»“æœ</button>
                <button class="tab-btn" onclick="switchTab('trades', this)">äº¤æ˜“è®°å½•</button>
                <button class="tab-btn" onclick="switchTab('cache-management', this)">æ•°æ®ç®¡ç†</button>
            </div>
            
            <!-- å›¾è¡¨æ ‡ç­¾é¡µ -->
            <div id="chart" class="tab-content active">
                <div id="chartLoading" class="loading" style="display: none;">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                <div id="chartError" class="error" style="display: none;"></div>
                
                <div class="chart-container" id="tradingview-chart"></div>
            </div>
            
            <!-- å›æµ‹ç»“æœæ ‡ç­¾é¡µ -->
            <div id="backtest" class="tab-content">
                <div id="backtestLoading" class="loading" style="display: none;">æ­£åœ¨è¿è¡Œå›æµ‹...</div>
                <div id="backtestError" class="error" style="display: none;"></div>
                
                <div id="backtestStats" class="stats-grid"></div>
                <div class="chart-container" id="equity-chart"></div>
            </div>
            
            <!-- äº¤æ˜“è®°å½•æ ‡ç­¾é¡µ -->
            <div id="trades" class="tab-content">
                <div id="tradesTable"></div>
            </div>
            
            <div id="cache-management" class="tab-content">
                <div class="cache-management-container">
                    <h3>æ•°æ®ç¼“å­˜ç®¡ç†</h3>
                    
                    <div class="cache-actions">
                        <button class="btn" onclick="getCacheStatus()">æ£€æŸ¥ç¼“å­˜çŠ¶æ€</button>
                        <button class="btn" onclick="warmUpCache()">é¢„çƒ­ç¼“å­˜</button>
                        <button class="btn" onclick="updateStockList()">æ›´æ–°è‚¡ç¥¨åˆ—è¡¨</button>
                        <button class="btn btn-secondary" onclick="cleanupCache()">æ¸…ç†ç¼“å­˜</button>
                    </div>
                    
                    <div id="cacheStatusContainer">
                        <div id="cacheLoading" class="loading" style="display: none;">æ­£åœ¨åŠ è½½ç¼“å­˜ä¿¡æ¯...</div>
                        <div id="cacheError" class="error" style="display: none;"></div>
                        <div id="cacheSuccess" class="success" style="display: none;"></div>
                        
                        <div id="cacheStatus" class="cache-status">
                            <h4>æ•°æ®æºçŠ¶æ€</h4>
                            <div id="sourceStatusTable"></div>
                            
                            <h4>ç¼“å­˜ç»Ÿè®¡</h4>
                            <div id="cacheStatsTable"></div>
                            
                            <h4>æ•°æ®è´¨é‡æŠ¥å‘Š</h4>
                            <div id="dataQualityTable"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TradingViewå›¾è¡¨å·¥å…· -->
    <script src="/static/chart_utils.js"></script>
    
    <script>
        let currentData = null;
        let backtestResults = null;
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(endDate.getFullYear() - 1);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName, targetElement) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            
            // å¦‚æœæœ‰ç›®æ ‡å…ƒç´ ï¼ˆä»æŒ‰é’®ç‚¹å‡»æ¥çš„ï¼‰ï¼Œåˆ™æ¿€æ´»è¯¥æŒ‰é’®
            if (targetElement) {
                targetElement.classList.add('active');
            } else {
                // å¦‚æœæ²¡æœ‰ç›®æ ‡å…ƒç´ ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®å¹¶æ¿€æ´»
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn.textContent.includes('ä»·æ ¼å›¾è¡¨') && tabName === 'chart') {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('å›æµ‹ç»“æœ') && tabName === 'backtest') {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('äº¤æ˜“è®°å½•') && tabName === 'trades') {
                        btn.classList.add('active');
                    } else if (btn.textContent.includes('æ•°æ®ç®¡ç†') && tabName === 'cache-management') {
                        btn.classList.add('active');
                    }
                });
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°æ•°æ®ç®¡ç†é¡µé¢ï¼Œè‡ªåŠ¨è·å–ç¼“å­˜çŠ¶æ€
            if (tabName === 'cache-management') {
                getCacheStatus();
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        // åŠ è½½è‚¡ç¥¨æ•°æ®
        async function loadData() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!stockCode || !startDate || !endDate) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è‚¡ç¥¨ä»£ç å’Œæ—¥æœŸï¼');
                return;
            }
            
            showLoading('chartLoading');
            hideError('chartError');
            
            try {
                const response = await fetch('/api/data/historical', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: stockCode,
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    currentData = result.data;
                    showSuccess('æ•°æ®åŠ è½½æˆåŠŸï¼');
                    drawChart(currentData);
                } else {
                    throw new Error('æœªè·å–åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç å’Œæ—¥æœŸèŒƒå›´');
                }
            } catch (error) {
                showError('chartError', `åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('chartLoading');
            }
        }
        
        // ç»˜åˆ¶å›¾è¡¨ - ä½¿ç”¨TradingView Lightweight Charts
        let currentPriceChart = null;
        
        function drawChart(data, trades = null) {
            console.log('=== drawChart Called ===');
            console.log('Data:', data ? data.length : 0);
            console.log('Trades:', trades);
            
            const chartContainer = document.getElementById('tradingview-chart');
            
            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (currentPriceChart) {
                try {
                    destroyChart(currentPriceChart);
                } catch (e) {
                    console.warn('é”€æ¯æ—§å›¾è¡¨å¤±è´¥:', e);
                }
                currentPriceChart = null;
            }
            
            // ä½¿ç”¨æ–°çš„TradingViewå›¾è¡¨å·¥å…·
            try {
                currentPriceChart = createPriceChart('tradingview-chart', data, trades);
            } catch (error) {
                console.error('ç»˜åˆ¶å›¾è¡¨å¤±è´¥:', error);
                chartContainer.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--danger-color);">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ç»˜åˆ¶å›æµ‹Kçº¿å›¾ï¼ˆå¸¦äº¤æ˜“ä¿¡å·ï¼‰
        function drawBacktestChart(data, trades) {
            // ç›´æ¥å¤ç”¨ä¸»å›¾è¡¨å‡½æ•°ï¼Œä¼ é€’äº¤æ˜“æ•°æ®
            drawChart(data, trades);
            
            // å¦‚æœéœ€è¦ç‰¹æ®Šçš„å›æµ‹å›¾è¡¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªå®šä¹‰
            // ç›®å‰ä½¿ç”¨åŒæ ·çš„Kçº¿å›¾æ˜¾ç¤ºé€»è¾‘
        }
        
        // è®¡ç®—ç§»åŠ¨å¹³å‡çº¿
        function calculateMA(prices, period) {
            const ma = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    ma.push(null);
                } else {
                    const sum = prices.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    ma.push(sum / period);
                }
            }
            return ma;
        }
        
        // ç»˜åˆ¶å‡€å€¼æ›²çº¿ - ä½¿ç”¨TradingView Lightweight Charts
        let currentEquityChart = null;
        
        function drawEquityCurve(equityData) {
            const chartContainer = document.getElementById('equity-chart');
            
            if (!equityData || equityData.length === 0) {
                chartContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">æš‚æ— æƒç›Šæ•°æ®</div>';
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (currentEquityChart) {
                try {
                    destroyChart(currentEquityChart);
                } catch (e) {
                    console.warn('é”€æ¯æ—§æƒç›Šå›¾è¡¨å¤±è´¥:', e);
                }
                currentEquityChart = null;
            }
            
            // ä½¿ç”¨æ–°çš„TradingViewå›¾è¡¨å·¥å…·
            try {
                currentEquityChart = createEquityChart('equity-chart', equityData);
            } catch (error) {
                console.error('ç»˜åˆ¶æƒç›Šæ›²çº¿å¤±è´¥:', error);
                chartContainer.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--danger-color);">æƒç›Šæ›²çº¿æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ç­–ç•¥åˆ‡æ¢æ—¶æ˜¾ç¤º/éšè—å¯¹åº”å‚æ•°
        function onStrategyChange() {
            const strategy = document.getElementById('strategy').value;
            
            // éšè—æ‰€æœ‰ç­–ç•¥å‚æ•°
            document.querySelectorAll('.strategy-params').forEach(el => {
                el.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­ç­–ç•¥çš„å‚æ•°
            const paramsId = strategy + '_params';
            const paramsEl = document.getElementById(paramsId);
            if (paramsEl) {
                paramsEl.style.display = 'block';
            }
            
            // å¦‚æœæ˜¯è‡ªå®šä¹‰ç­–ç•¥,åˆå§‹åŒ–Monacoç¼–è¾‘å™¨
            if (strategy === 'custom') {
                // å»¶è¿Ÿåˆå§‹åŒ–,ç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                    if (!monacoEditor) {
                        initMonacoEditor();
                    }
                }, 100);
            }
        }
        
                // è·å–å½“å‰ç­–ç•¥å‚æ•°
        function getCurrentStrategyParams() {
            const strategy = document.getElementById('strategy').value;
            const params = {};
            
            switch(strategy) {
                case 'ma_cross':
                    params.short_window = parseInt(document.getElementById('shortWindow').value);
                    params.long_window = parseInt(document.getElementById('longWindow').value);
                    break;
                    
                case 'rsi':
                    params.period = parseInt(document.getElementById('rsiPeriod').value);
                    params.oversold_threshold = parseFloat(document.getElementById('oversoldThreshold').value);
                    params.overbought_threshold = parseFloat(document.getElementById('overboughtThreshold').value);
                    params.stop_loss = parseFloat(document.getElementById('rsiStopLoss').value);
                    params.take_profit = parseFloat(document.getElementById('rsiTakeProfit').value);
                    break;
                    
                case 'bollinger':
                    params.period = parseInt(document.getElementById('bollingerPeriod').value);
                    params.std_multiplier = parseFloat(document.getElementById('stdMultiplier').value);
                    params.stop_loss = parseFloat(document.getElementById('bollingerStopLoss').value);
                    params.take_profit = parseFloat(document.getElementById('bollingerTakeProfit').value);
                    break;
                    
                case 'custom':
                    params.custom_code = getEditorCode();
                    break;
            }
            
            return params;
        }
        
        // éªŒè¯ç­–ç•¥å‚æ•°
        function validateStrategyParams(strategy, params) {
            switch(strategy) {
                case 'ma_cross':
                    if (params.short_window >= params.long_window) {
                        alert('çŸ­æœŸå‡çº¿å‘¨æœŸå¿…é¡»å°äºé•¿æœŸå‡çº¿å‘¨æœŸï¼');
                        return false;
                    }
                    break;
                    
                case 'rsi':
                    if (params.oversold_threshold >= params.overbought_threshold) {
                        alert('è¶…å–é˜ˆå€¼å¿…é¡»å°äºè¶…ä¹°é˜ˆå€¼ï¼');
                        return false;
                    }
                    break;
                    
                case 'custom':
                    if (!params.custom_code || !params.custom_code.trim()) {
                        alert('è¯·è¾“å…¥è‡ªå®šä¹‰äº¤æ˜“é€»è¾‘ä»£ç ï¼');
                        return false;
                    }
                    break;
            }
            return true;
        }
        
                async function runBacktest() {
            if (!currentData) {
                alert('è¯·å…ˆåŠ è½½è‚¡ç¥¨æ•°æ®ï¼');
                return;
            }
            
            const strategy = document.getElementById('strategy').value;
            const stockCode = document.getElementById('stockCode').value.trim();
            const params = getCurrentStrategyParams();
            
            // éªŒè¯å‚æ•°
            if (!validateStrategyParams(strategy, params)) {
                return;
            }
            
            showLoading('backtestLoading');
            hideError('backtestError');
            
            try {
                const response = await fetch('/api/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: stockCode,
                        strategy: strategy,
                        params: params,
                        data: currentData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    backtestResults = result;
                    displayBacktestResults(result);
                    switchTab('backtest');
                    showSuccess(`${getStrategyName(strategy)}å›æµ‹å®Œæˆï¼`);
                } else {
                    throw new Error(result.error || 'å›æµ‹å¤±è´¥');
                }
            } catch (error) {
                showError('backtestError', `å›æµ‹å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('backtestLoading');
            }
        }
        
        // è·å–ç­–ç•¥ä¸­æ–‡åç§°
        function getStrategyName(strategy) {
            const names = {
                'ma_cross': 'åŒå‡çº¿äº¤å‰ç­–ç•¥',
                'rsi': 'RSIè¶…ä¹°è¶…å–ç­–ç•¥',
                'bollinger': 'å¸ƒæ—å¸¦ç­–ç•¥',
                'custom': 'è‡ªå®šä¹‰ç­–ç•¥'
            };
            return names[strategy] || strategy;
        }
        
        // æ˜¾ç¤ºå›æµ‹ç»“æœ
        function displayBacktestResults(results) {
            const metrics = results.metrics;
            
            const statsHtml = `
                <div class="stat-card ${metrics.total_return >= 0 ? 'positive' : 'negative'}">
                    <h3>æ€»æ”¶ç›Šç‡</h3>
                    <div class="value">${metrics.total_return.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h3>å¹´åŒ–æ”¶ç›Šç‡</h3>
                    <div class="value">${metrics.annualized_return.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h3>å¤æ™®æ¯”ç‡</h3>
                    <div class="value">${metrics.sharpe_ratio.toFixed(2)}</div>
                </div>
                <div class="stat-card negative">
                    <h3>æœ€å¤§å›æ’¤</h3>
                    <div class="value">${metrics.max_drawdown.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <h3>èƒœç‡</h3>
                    <div class="value">${metrics.win_rate.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <h3>äº¤æ˜“æ¬¡æ•°</h3>
                    <div class="value">${metrics.total_trades}</div>
                </div>
            `;
            
            document.getElementById('backtestStats').innerHTML = statsHtml;
            
            // é‡æ–°ç»˜åˆ¶ä¸»å›¾è¡¨ï¼Œè¿™æ¬¡åŒ…å«äº¤æ˜“ä¿¡å·
            if (currentData && results.trades) {
                console.log('=== Backtest Results Debug ===');
                console.log('Data points:', currentData.length);
                console.log('Trades:', results.trades);
                console.log('First trade:', results.trades[0]);
                console.log('Last trade:', results.trades[results.trades.length - 1]);
                
                // æ›´æ–°ä¸»å›¾è¡¨æ˜¾ç¤ºäº¤æ˜“ä¿¡å·
                drawChart(currentData, results.trades);
            }
            
            // æ˜¾ç¤ºå‡€å€¼æ›²çº¿
            const equityChart = document.getElementById('equity-chart');
            if (results.equity_curve && results.equity_curve.length > 0) {
                drawEquityCurve(results.equity_curve);
            } else {
                equityChart.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <div style="text-align: center;">
                            <h3>ğŸ“Š å‡€å€¼æ›²çº¿</h3>
                            <p>æœ€ç»ˆå‡€å€¼: Â¥${metrics.final_value.toFixed(0)}</p>
                            <p>æ”¶ç›Šç‡: ${metrics.total_return.toFixed(2)}%</p>
                        </div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºäº¤æ˜“è®°å½•
            displayTrades(results.trades);
        }
        
        // æ˜¾ç¤ºäº¤æ˜“è®°å½•
        function displayTrades(trades) {
            let tradesHtml = '<h3>äº¤æ˜“è®°å½•</h3>';
            
            if (trades && trades.length > 0) {
                tradesHtml += `
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                                <th>ä»·æ ¼</th>
                                <th>æ•°é‡</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                trades.forEach(trade => {
                    tradesHtml += `
                        <tr>
                            <td>${trade.date}</td>
                            <td>${trade.action}</td>
                            <td>Â¥${trade.price.toFixed(2)}</td>
                            <td>${trade.quantity}</td>
                            <td>${trade.reason}</td>
                        </tr>
                    `;
                });
                
                tradesHtml += '</tbody></table>';
            } else {
                tradesHtml += '<p style="text-align: center; color: #666; margin-top: 2rem;">æš‚æ— äº¤æ˜“è®°å½•</p>';
            }
            
            document.getElementById('tradesTable').innerHTML = tradesHtml;
        }
        
        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            // ç®€å•çš„æˆåŠŸæç¤º
            const successEl = document.createElement('div');
            successEl.className = 'success';
            successEl.textContent = message;
            successEl.style.position = 'fixed';
            successEl.style.top = '20px';
            successEl.style.right = '20px';
            successEl.style.zIndex = '1000';
            
            document.body.appendChild(successEl);
            
            setTimeout(() => {
                successEl.remove();
            }, 3000);
        }
        
        // æ•°æ®ç®¡ç†åŠŸèƒ½
        async function getCacheStatus() {
            const container = document.getElementById('cacheStatusContainer');
            showLoading('cacheLoading');
            hideError('cacheError');
            hideSuccess('cacheSuccess');
            
            try {
                const response = await fetch('/api/cache/status');
                const result = await response.json();
                
                if (result.success) {
                    displayCacheStatus(result);
                    showSuccess('ç¼“å­˜çŠ¶æ€è·å–æˆåŠŸï¼');
                } else {
                    throw new Error(result.detail || 'è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                showError('cacheError', `è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('cacheLoading');
            }
        }
        
        function displayCacheStatus(data) {
            // æ˜¾ç¤ºæ•°æ®æºçŠ¶æ€
            const sourceStatus = data.source_status || {};
            let sourceHtml = '<div class="status-card">';
            
            Object.keys(sourceStatus).forEach(sourceName => {
                const source = sourceStatus[sourceName];
                const statusClass = source.api_calls_24h > 0 ? 'status-good' : 'status-warning';
                
                sourceHtml += `
                    <div class="status-item">
                        <span class="status-label">${sourceName}</span>
                        <span class="status-value ${statusClass}">
                            ${source.stock_count || 0} æ”¯è‚¡ç¥¨, ${source.api_calls_24h || 0} æ¬¡APIè°ƒç”¨
                        </span>
                    </div>
                `;
            });
            
            sourceHtml += '</div>';
            document.getElementById('sourceStatusTable').innerHTML = sourceHtml;
            
            // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
            const cacheStats = data.cache_statistics || {};
            let cacheHtml = '<div class="status-card">';
            
            Object.keys(cacheStats).forEach(sourceName => {
                const stats = cacheStats[sourceName];
                cacheHtml += `
                    <div class="status-item">
                        <span class="status-label">${sourceName} å“åº”æ—¶é—´</span>
                        <span class="status-value">${Math.round(stats.avg_response_time_ms || 0)}ms</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">${sourceName} æˆåŠŸç‡</span>
                        <span class="status-value status-good">
                            ${stats.successful_calls_24h || 0}/${stats.api_calls_24h || 0}
                        </span>
                    </div>
                `;
            });
            
            cacheHtml += '</div>';
            document.getElementById('cacheStatsTable').innerHTML = cacheHtml;
        }
        
        async function warmUpCache() {
            showLoading('cacheLoading');
            hideError('cacheError');
            
            try {
                const response = await fetch('/api/cache/warmup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbols: null, // ä½¿ç”¨é»˜è®¤è‚¡ç¥¨
                        days: 365
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message || 'ç¼“å­˜é¢„çƒ­å®Œæˆï¼');
                    getCacheStatus(); // åˆ·æ–°çŠ¶æ€
                } else {
                    throw new Error(result.detail || 'ç¼“å­˜é¢„çƒ­å¤±è´¥');
                }
            } catch (error) {
                showError('cacheError', `ç¼“å­˜é¢„çƒ­å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('cacheLoading');
            }
        }
        
        async function updateStockList() {
            showLoading('cacheLoading');
            hideError('cacheError');
            
            try {
                const response = await fetch('/api/data/update', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message || 'è‚¡ç¥¨åˆ—è¡¨æ›´æ–°å®Œæˆï¼');
                    getCacheStatus(); // åˆ·æ–°çŠ¶æ€
                } else {
                    throw new Error(result.detail || 'è‚¡ç¥¨åˆ—è¡¨æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                showError('cacheError', `è‚¡ç¥¨åˆ—è¡¨æ›´æ–°å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('cacheLoading');
            }
        }
        
        async function cleanupCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤30å¤©å‰çš„æ•°æ®ã€‚')) {
                return;
            }
            
            showLoading('cacheLoading');
            hideError('cacheError');
            
            try {
                const response = await fetch('/api/cache/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        days: 30
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message || 'ç¼“å­˜æ¸…ç†å®Œæˆï¼');
                    getCacheStatus(); // åˆ·æ–°çŠ¶æ€
                } else {
                    throw new Error(result.detail || 'ç¼“å­˜æ¸…ç†å¤±è´¥');
                }
            } catch (error) {
                showError('cacheError', `ç¼“å­˜æ¸…ç†å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading('cacheLoading');
            }
        }
        
        
        // è‡ªå®šä¹‰ç­–ç•¥ç›¸å…³å‡½æ•°
        function loadTemplate() {
            const select = document.getElementById('templateSelect');
            
            const templates = {
                'ma_cross': `# åŒå‡çº¿äº¤å‰ç­–ç•¥
# ä½¿ç”¨current.ma5å’Œcurrent.ma20è®¿é—®æŒ‡æ ‡æ•°æ®
# é‡‘å‰ä¹°å…¥
if current.ma5 > current.ma20 and prev.ma5 <= prev.ma20 and position == 0:
    signal = 1
    reason = f'MAé‡‘å‰ä¹°å…¥: MA5={current.ma5:.2f} > MA20={current.ma20:.2f}'
# æ­»å‰å–å‡º
elif current.ma5 < current.ma20 and prev.ma5 >= prev.ma20 and position == 1:
    signal = -1
    reason = f'MAæ­»å‰å–å‡º: MA5={current.ma5:.2f} < MA20={current.ma20:.2f}'
`,
    
                'rsi_divergence': `# RSIè¶…ä¹°è¶…å–ç­–ç•¥
# ä½¿ç”¨rsi14æŒ‡æ ‡
if current.rsi14 < 30 and position == 0:
    signal = 1
    reason = f'RSIè¶…å–({current.rsi14:.1f})ï¼Œä¹°å…¥'
elif current.rsi14 > 70 and position == 1:
    signal = -1
    reason = f'RSIè¶…ä¹°({current.rsi14:.1f})ï¼Œå–å‡º'
`,
    
                'bollinger_bounce': `# å¸ƒæ—å¸¦åå¼¹ç­–ç•¥
# ä»·æ ¼æ¥è¿‘ä¸‹è½¨ä¹°å…¥ï¼Œæ¥è¿‘ä¸Šè½¨å–å‡º
bb_range = current.bb_upper - current.bb_lower
lower_trigger = current.bb_lower + bb_range * 0.1  # ä¸‹è½¨ä¸Šæ–¹10%èŒƒå›´
upper_trigger = current.bb_upper - bb_range * 0.1  # ä¸Šè½¨ä¸‹æ–¹10%èŒƒå›´

if current.close < lower_trigger and position == 0:
    signal = 1
    reason = f'ä»·æ ¼{current.close:.2f}æ¥è¿‘å¸ƒæ—å¸¦ä¸‹è½¨{current.bb_lower:.2f}ï¼Œä¹°å…¥'
elif current.close > upper_trigger and position == 1:
    signal = -1
    reason = f'ä»·æ ¼{current.close:.2f}æ¥è¿‘å¸ƒæ—å¸¦ä¸Šè½¨{current.bb_upper:.2f}ï¼Œå–å‡º'
`,
    
                'volume_breakout': `# æˆäº¤é‡çªç ´ç­–ç•¥
# çªç ´è¿‘æœŸé«˜ç‚¹ä¸”æˆäº¤é‡æ”¾å¤§
if current.close > prev.high and current.volume_ratio > 1.2 and position == 0:
    signal = 1
    reason = f'ä»·æ ¼{current.close:.2f}çªç ´å‰é«˜{prev.high:.2f}ï¼Œæˆäº¤é‡æ”¾å¤§{current.volume_ratio:.1f}å€'
elif current.close < current.ma20 and position == 1:
    signal = -1
    reason = f'ä»·æ ¼{current.close:.2f}è·Œç ´å‡çº¿{current.ma20:.2f}'
`,

                'multi_factor': `# å¤šå› å­ç»¼åˆç­–ç•¥
# ä½¿ç”¨æŠ€æœ¯é¢ç»¼åˆè¯„åˆ†å’Œè‡ªå®šä¹‰å› å­
tech_score = current.tech_score if not pd.isna(current.tech_score) else 0
momentum = current.momentum_factor if not pd.isna(current.momentum_factor) else 0
trend_strength = current.trend_strength if not pd.isna(current.trend_strength) else 0
volume_factor = current.price_volume_factor if not pd.isna(current.price_volume_factor) else 0

# ç»¼åˆè¯„åˆ†è®¡ç®—
composite_score = (
    tech_score * 0.3 +
    momentum * 0.25 +
    trend_strength * 0.25 +
    volume_factor * 0.2
)

if composite_score > 0.6 and position == 0:
    signal = 1
    reason = f'ç»¼åˆè¯„åˆ†ä¹°å…¥: {composite_score:.2f}'
elif composite_score < -0.6 and position == 1:
    signal = -1
    reason = f'ç»¼åˆè¯„åˆ†å–å‡º: {composite_score:.2f}'
else:
    signal = 0
    reason = ''`,

                'custom_indicators': `# è‡ªå®šä¹‰æŒ‡æ ‡ç­–ç•¥
# ä½¿ç”¨è‡ªå®šä¹‰å› å­æ„å»ºå‡½æ•°

# è®¡ç®—è‡ªå®šä¹‰20æ—¥RSI
if len(history_20) >= 20:
    my_rsi = custom_rsi(history_20['close'], period=20).iloc[-1]
else:
    my_rsi = 50

# è®¡ç®—è‡ªå®šä¹‰å¸ƒæ—å¸¦ä½ç½®
if len(history_20) >= 20:
    bb = custom_bollinger(history_20['close'], period=20, std_dev=2.5)
    bb_position = bb['percent'].iloc[-1]
else:
    bb_position = 0.5

# ä»·æ ¼å¼ºåº¦æ£€æŸ¥
price_strength = current.price_strength if not pd.isna(current.price_strength) else 1
volume_surge = current.volume_ratio > 1.8 if not pd.isna(current.volume_ratio) else False

# å¤šæ¡ä»¶åˆ¤æ–­
oversold = my_rsi < 25 and bb_position < 0.1 and volume_surge
overbought = my_rsi > 75 and bb_position > 0.9

if oversold and price_strength > 0.95 and position == 0:
    signal = 1
    reason = f'è‡ªå®šä¹‰æŒ‡æ ‡ä¹°å…¥: RSI={my_rsi:.1f}, BBä½ç½®={bb_position:.2f}'
elif overbought and position == 1:
    signal = -1
    reason = f'è‡ªå®šä¹‰æŒ‡æ ‡å–å‡º: RSI={my_rsi:.1f}, BBä½ç½®={bb_position:.2f}'
else:
    signal = 0
    reason = ''`,

                'mean_reversion': `# å‡å€¼å›å½’ç­–ç•¥
# ä½¿ç”¨Z-Scoreæ ‡å‡†åŒ–å’Œå¤šé‡ç¡®è®¤

# è®¡ç®—ä»·æ ¼Z-Score
if len(history_20) >= 20:
    price_zscore = custom_zscore(history_20['close'], 20).iloc[-1]
else:
    price_zscore = 0

# æˆäº¤é‡å’Œå¸ƒæ—å¸¦ç¡®è®¤
volume_surge = current.volume_ratio > 2.0 if not pd.isna(current.volume_ratio) else False
bb_position = current.bb20_percent_20 if not pd.isna(current.bb20_percent_20) else 0.5

# æç«¯å‡å€¼å›å½’ä¿¡å·
extreme_oversold = price_zscore < -2.5 and bb_position < 0.05
extreme_overbought = price_zscore > 2.5 and bb_position > 0.95

if extreme_oversold and volume_surge and position == 0:
    signal = 1
    reason = f'æç«¯è¶…å–å›å½’: Z-Score={price_zscore:.2f}'
elif extreme_overbought and position == 1:
    signal = -1
    reason = f'æç«¯è¶…ä¹°å›å½’: Z-Score={price_zscore:.2f}'
elif abs(price_zscore) < 0.5 and position == 1:
    signal = -1
    reason = f'å›å½’å‡å€¼: Z-Score={price_zscore:.2f}'
else:
    signal = 0
    reason = ''`
            };
            
            if (select.value && templates[select.value]) {
                setEditorCode(templates[select.value]);
                validateCode();
            }
        }
        
        function validateCode() {
            const validation = document.getElementById('codeValidation');
            const code = getEditorCode().trim();
            
            if (!code) {
                validation.style.display = 'none';
                return;
            }
            
            // åŸºæœ¬è¯­æ³•æ£€æŸ¥
            try {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„å˜é‡è®¾ç½®
                if (!code.includes('signal') || !code.includes('reason')) {
                    throw new Error('ä»£ç å¿…é¡»è®¾ç½® signal å’Œ reason å˜é‡');
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å±é™©æ“ä½œ
                const dangerous = ['import ', 'exec', 'eval', '__', 'open(', 'file', 'os.', 'sys.'];
                for (let danger of dangerous) {
                    if (code.includes(danger)) {
                        throw new Error(`ä¸å…è®¸ä½¿ç”¨ ${danger}`);
                    }
                }
                
                validation.innerHTML = '<strong>âœ… ä»£ç éªŒè¯é€šè¿‡</strong><br>å¯ä»¥å®‰å…¨è¿è¡Œæ­¤ç­–ç•¥';
                validation.style.background = 'rgba(38, 166, 154, 0.15)';
                validation.style.color = '#26A69A';
                validation.style.border = '1px solid #26A69A';
                validation.style.display = 'block';
                
            } catch (error) {
                validation.innerHTML = `<strong>âŒ éªŒè¯å¤±è´¥</strong><br>${error.message}`;
                validation.style.background = 'rgba(239, 83, 80, 0.15)';
                validation.style.color = '#EF5350';
                validation.style.border = '1px solid #EF5350';
                validation.style.display = 'block';
            }
        }
        
        // Monaco Editorå®ä¾‹
        let monacoEditor = null;
        
        // åˆå§‹åŒ–Monaco Editor
        function initMonacoEditor() {
            require.config({ 
                paths: { 
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
                } 
            });
            
            require(['vs/editor/editor.main'], function() {
                const defaultCode = `# å¯ç”¨å˜é‡:
# current - å½“å‰æ•°æ®è¡Œ (åŒ…å«: open, high, low, close, volume, ma5, ma10, ma20, rsiç­‰147+ä¸ªæŒ‡æ ‡)
# prev - å‰ä¸€è¡Œæ•°æ®
# position - å½“å‰æŒä»“çŠ¶æ€ (0=ç©ºä»“, >0=æŒä»“)
# entry_price - ä¹°å…¥ä»·æ ¼
# data - å®Œæ•´å†å²æ•°æ®DataFrame

# ç¤ºä¾‹ä»£ç : ç®€å•çš„åŒå‡çº¿äº¤å‰ç­–ç•¥
if not pd.isna(current.ma5) and not pd.isna(current.ma20):
    if not pd.isna(prev.ma5) and not pd.isna(prev.ma20):
        # é‡‘å‰ä¹°å…¥
        if current.ma5 > current.ma20 and prev.ma5 <= prev.ma20 and position == 0:
            signal = 1
            reason = f'MAé‡‘å‰ä¹°å…¥: MA5={current.ma5:.2f} > MA20={current.ma20:.2f}'
        # æ­»å‰å–å‡º
        elif current.ma5 < current.ma20 and prev.ma5 >= prev.ma20 and position > 0:
            signal = -1
            reason = f'MAæ­»å‰å–å‡º: MA5={current.ma5:.2f} < MA20={current.ma20:.2f}'
        else:
            signal = 0
            reason = ''

# å¿…é¡»è®¾ç½®çš„å˜é‡:
# signal: 1=ä¹°å…¥, -1=å–å‡º, 0=æ— æ“ä½œ
# reason: äº¤æ˜“ç†ç”±æ–‡å­—è¯´æ˜`;
                
                monacoEditor = monaco.editor.create(document.getElementById('customCodeEditor'), {
                    value: defaultCode,
                    language: 'python',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 13,
                    minimap: { enabled: true },
                    scrollBeyondLastLine: false,
                    wordWrap: 'on',
                    lineNumbers: 'on',
                    folding: true,
                    renderWhitespace: 'selection',
                    bracketPairColorization: { enabled: true },
                    tabSize: 4,
                    insertSpaces: true,
                    suggest: {
                        showKeywords: true,
                        showSnippets: true
                    }
                });
                
                // æ·»åŠ Pythonä»£ç è¡¥å…¨
                monaco.languages.registerCompletionItemProvider('python', {
                    provideCompletionItems: function(model, position) {
                        const suggestions = [
                            {
                                label: 'current',
                                kind: monaco.languages.CompletionItemKind.Variable,
                                insertText: 'current.',
                                documentation: 'å½“å‰æ•°æ®è¡Œï¼Œå¯è®¿é—®æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡'
                            },
                            {
                                label: 'prev',
                                kind: monaco.languages.CompletionItemKind.Variable,
                                insertText: 'prev.',
                                documentation: 'å‰ä¸€è¡Œæ•°æ®'
                            },
                            {
                                label: 'position',
                                kind: monaco.languages.CompletionItemKind.Variable,
                                insertText: 'position',
                                documentation: 'å½“å‰æŒä»“çŠ¶æ€ (0=ç©ºä»“, >0=æŒä»“)'
                            },
                            {
                                label: 'signal',
                                kind: monaco.languages.CompletionItemKind.Variable,
                                insertText: 'signal = ',
                                documentation: 'äº¤æ˜“ä¿¡å·: 1=ä¹°å…¥, -1=å–å‡º, 0=æ— æ“ä½œ'
                            },
                            {
                                label: 'reason',
                                kind: monaco.languages.CompletionItemKind.Variable,
                                insertText: 'reason = ',
                                documentation: 'äº¤æ˜“ç†ç”±è¯´æ˜'
                            },
                            // å¸¸ç”¨æŒ‡æ ‡
                            {
                                label: 'current.ma5',
                                kind: monaco.languages.CompletionItemKind.Property,
                                insertText: 'current.ma5',
                                documentation: '5æ—¥ç§»åŠ¨å¹³å‡çº¿'
                            },
                            {
                                label: 'current.ma20',
                                kind: monaco.languages.CompletionItemKind.Property,
                                insertText: 'current.ma20',
                                documentation: '20æ—¥ç§»åŠ¨å¹³å‡çº¿'
                            },
                            {
                                label: 'current.rsi',
                                kind: monaco.languages.CompletionItemKind.Property,
                                insertText: 'current.rsi',
                                documentation: 'RSIç›¸å¯¹å¼ºå¼±æŒ‡æ ‡'
                            },
                            {
                                label: 'current.macd',
                                kind: monaco.languages.CompletionItemKind.Property,
                                insertText: 'current.macd',
                                documentation: 'MACDæŒ‡æ ‡'
                            }
                        ];
                        return { suggestions: suggestions };
                    }
                });
            });
        }
        
        // è·å–ç¼–è¾‘å™¨ä»£ç 
        function getEditorCode() {
            return monacoEditor ? monacoEditor.getValue() : '';
        }
        
        // è®¾ç½®ç¼–è¾‘å™¨ä»£ç 
        function setEditorCode(code) {
            if (monacoEditor) {
                monacoEditor.setValue(code);
            }
        }
        
        // æ¸…ç©ºä»£ç 
        function clearCode() {
            if (monacoEditor) {
                monacoEditor.setValue('');
            }
            document.getElementById('codeValidation').style.display = 'none';
            document.getElementById('templateSelect').value = '';
        }
        
        // å®ç°ä¾§è¾¹æ å¯æ‹–æ‹½è°ƒæ•´å¤§å°
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const sidebar = document.querySelector('.sidebar');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = sidebar.offsetWidth;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                const newWidth = startWidth + diff;
                const maxWidth = window.innerWidth * 0.5; // æœ€å¤§50%å±å¹•å®½åº¦
                
                // é™åˆ¶æœ€å°å’Œæœ€å¤§å®½åº¦
                if (newWidth >= 250 && newWidth <= maxWidth) {
                    sidebar.style.width = newWidth + 'px';
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            onStrategyChange(); // åˆå§‹åŒ–ç­–ç•¥å‚æ•°æ˜¾ç¤º
            initResizer(); // åˆå§‹åŒ–æ‹–æ‹½è°ƒæ•´å¤§å°
            
            // å»¶è¿Ÿåˆå§‹åŒ–Monaco Editor
            setTimeout(initMonacoEditor, 100);
        });
    </script>
    <!-- Monaco EditoråŠ è½½å™¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
</body>
</html>